# 올리브영 랭킹 크롤링 시스템

올리브영의 21개 카테고리 랭킹 데이터를 자동으로 크롤링하고 캡처하여 이메일로 전송하는 시스템입니다.

## 🚀 주요 기능

### 📊 크롤링 기능
- **21개 카테고리 순차 크롤링**: 전체, 스킨케어, 마스크팩, 클렌징, 선케어, 메이크업, 네일, 뷰티소품, 더모_코스메틱, 맨즈케어, 향수_디퓨저, 헤어케어, 바디케어, 건강식품, 푸드, 구강용품, 헬스_건강용품, 여성_위생용품, 패션, 리빙_가전, 취미_팬시
- **1차/2차 시도 로직**: 실패한 카테고리만 재시도
- **실시간 데이터 추출**: 상품명, 브랜드, 가격, 프로모션 정보
- **월별 데이터 저장**: JSON 형태로 누적 저장

### 📸 캡처 기능
- **21개 카테고리 순차 캡처**: 각 카테고리별 랭킹 페이지 스크린샷
- **1차/2차 시도 로직**: 실패한 카테고리만 재시도
- **고화질 캡처**: JPEG 100% 품질로 저장
- **자동 이메일 전송**: ZIP 파일로 압축하여 분할 전송 (최대 7개 파일/메일)
- **자동 파일 정리**: 이메일 전송 후 캡처본 자동 삭제

### ⏰ 스케줄링
- **1시간 간격 자동 실행**: 매시간 15분에 실행
- **KST 시간대 지원**: 한국 시간 기준으로 동작
- **자동 재시작**: 실패 시 다음 스케줄까지 대기

## 🔧 기술 스택

- **Backend**: Node.js, Express.js
- **Web Scraping**: Selenium WebDriver, Chrome
- **Image Processing**: Sharp
- **Email**: Nodemailer
- **Scheduling**: node-cron
- **File Compression**: Archiver

## 📋 워크플로우

### 1단계: 크롤링 (21개 카테고리)
```
1. 21개 카테고리 순서대로 크롤링 시도
2. 실패한 카테고리만 2차 크롤링 진행
3. 크롤링한 데이터 모두 저장 (JSON)
```

### 2단계: 캡처 (21개 카테고리)
```
1. 21개 카테고리 순서대로 캡처 시도
2. 실패한 카테고리만 2차 캡처 진행
3. 캡처한 데이터 이메일로 ZIP 파일 압축 전송 (3개 파일로 분할)
4. 이메일 전송 후 캡처본 전체 삭제
```

## 🛠️ 설치 및 실행

### 1. 의존성 설치
```bash
npm install
```

### 2. 환경 변수 설정
`.env` 파일 생성:
```env
EMAIL_USER=your-email@worksmobile.com
EMAIL_PASS=your-email-password
CHROME_BIN=/usr/bin/google-chrome-stable
PORT=5001
```

### 3. 서버 실행
```bash
npm start
```

## 📊 API 엔드포인트

### 랭킹 데이터 조회
```
GET /api/ranking?category=스킨케어&yearMonth=2025-01
```

### 검색
```
GET /api/search?keyword=토너&startDate=2025-01-01&category=스킨케어
```

### 마지막 크롤링 시간
```
GET /api/last-crawl-time
```

### 헬스 체크
```
GET /health
```

## 📁 파일 구조

```
oliveyoung/
├── server.js              # 메인 서버 파일
├── package.json           # 프로젝트 설정
├── .env                   # 환경 변수
├── data/                  # 크롤링 데이터 저장
│   └── ranking_2025-01.json
├── public/                # 정적 파일
│   ├── olive.html         # 메인 페이지
│   ├── olive.css          # 스타일시트
│   ├── script.js          # 클라이언트 스크립트
│   └── captures/          # 캡처 파일 (임시)
└── Dockerfile             # Docker 설정
```

## 🔍 모니터링

### 로그 확인
```bash
# 실시간 로그 확인
tail -f logs/app.log

# 크롤링 상태 확인
curl http://localhost:5001/health
```

### 성공률 모니터링
- 크롤링 성공률: 21개 카테고리 중 성공한 개수
- 캡처 성공률: 21개 카테고리 중 캡처 성공한 개수
- 이메일 전송 상태: ZIP 파일 분할 전송 결과

## ⚠️ 주의사항

1. **Chrome 설치 필요**: 시스템에 Google Chrome이 설치되어 있어야 합니다.
2. **이메일 설정**: Works Mobile SMTP 설정이 필요합니다.
3. **디스크 공간**: 캡처 파일이 임시로 생성되므로 충분한 디스크 공간이 필요합니다.
4. **네트워크 안정성**: 크롤링 중 네트워크 오류 시 자동 재시도됩니다.

## 🐛 문제 해결

### Chrome 드라이버 오류
```bash
# Chrome 경로 확인
which google-chrome-stable

# Chrome 버전 확인
google-chrome-stable --version
```

### 메모리 부족
- Chrome 옵션에서 `--disable-dev-shm-usage` 사용
- 임시 프로필 자동 정리

### 이메일 전송 실패
- SMTP 설정 확인
- 파일 크기 제한 확인 (25MB 이하)

## 📈 성능 최적화

- **병렬 처리**: 카테고리별 독립적인 드라이버 사용
- **리소스 정리**: 자동 드라이버 종료 및 임시 파일 삭제
- **재시도 로직**: 실패한 카테고리만 선택적 재시도
- **메모리 관리**: 임시 프로필 자동 정리

## 🔄 업데이트 로그

### v1.0.0
- 21개 카테고리 크롤링 및 캡처 기능
- 1시간 간격 자동 실행
- 이메일 자동 전송
- API 엔드포인트 제공 