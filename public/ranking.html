<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>올리브영 랭킹 트래커</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .rank-change {
            font-size: 0.9em;
            margin-left: 5px;
            font-weight: bold;
            display: inline-block;
            min-width: 30px;
            text-align: center;
        }
        .rank-change.up {
            color: #0d6efd;
            background-color: rgba(13, 110, 253, 0.1);
            border-radius: 4px;
            padding: 2px 4px;
        }
        .rank-change.down {
            color: #dc3545;
            background-color: rgba(220, 53, 69, 0.1);
            border-radius: 4px;
            padding: 2px 4px;
        }
        .rank-number {
            font-weight: bold;
            color: #495057;
        }
        #lastUpdate {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 5px;
        }
        .table th {
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .table td {
            vertical-align: middle;
        }
        .product-name {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .price {
            font-family: monospace;
            text-align: right;
        }
        .event-tag {
            background-color: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85em;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row mb-3">
            <div class="col">
                <h2 class="mb-1">올리브영 랭킹 트래커</h2>
                <div id="lastUpdate" class="text-muted"></div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-3">
                <select id="categorySelect" class="form-select">
                    <option value="">카테고리 선택</option>
                </select>
            </div>
            <div class="col-md-3">
                <input type="date" id="dateSelect" class="form-control">
            </div>
        </div>

        <div class="table-responsive">
            <table id="rankingTable" class="table table-hover">
                <thead>
                    <tr>
                        <th style="width: 80px">순위</th>
                        <th style="width: 120px">브랜드</th>
                        <th>제품명</th>
                        <th style="width: 100px">소비자가</th>
                        <th style="width: 100px">판매가</th>
                        <th style="width: 150px">행사</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        function updateTable(rankings) {
            const tbody = document.querySelector('#rankingTable tbody');
            tbody.innerHTML = '';

            if (!Array.isArray(rankings) || rankings.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="6" class="text-center">데이터가 없습니다.</td>`;
                tbody.appendChild(row);
                return;
            }

            rankings.forEach(item => {
                const row = document.createElement('tr');
                const rankChange = item.rank_change;
                const rankChangeClass = rankChange === 'up' ? 'up' : 
                                      rankChange === 'down' ? 'down' : '';
                const rankChangeIcon = rankChange === 'up' ? '▲' : 
                                     rankChange === 'down' ? '▼' : '';
                const rankChangeText = rankChange ? 
                    `<span class="rank-change ${rankChangeClass}">${rankChangeIcon}${item.rank_change_amount || ''}</span>` : '';

                row.innerHTML = `
                    <td>
                        <span class="rank-number">${item.rank}</span>
                        ${rankChangeText}
                    </td>
                    <td>${item.brand}</td>
                    <td class="product-name">${item.product}</td>
                    <td class="price">${item.originalPrice}</td>
                    <td class="price">${item.salePrice}</td>
                    <td>
                        ${item.event ? `<span class="event-tag">${item.event}</span>` : '-'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateLastUpdateTime() {
            fetch('/api/last-update')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.lastUpdate) {
                        const lastUpdate = new Date(data.lastUpdate);
                        const now = new Date();
                        const diffMinutes = Math.floor((now - lastUpdate) / (1000 * 60));
                        
                        let timeText;
                        if (diffMinutes < 1) {
                            timeText = '방금 전';
                        } else if (diffMinutes < 60) {
                            timeText = `${diffMinutes}분 전`;
                        } else {
                            const diffHours = Math.floor(diffMinutes / 60);
                            timeText = `${diffHours}시간 전`;
                        }
                        
                        document.getElementById('lastUpdate').textContent = `마지막 업데이트: ${timeText}`;
                    }
                })
                .catch(error => console.error('업데이트 시간 조회 실패:', error));
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', () => {
            updateLastUpdateTime();
            setInterval(updateLastUpdateTime, 60000);

            // 카테고리 목록 로드
            fetch('/api/categories')
                .then(response => response.json())
                .then(categories => {
                    const select = document.getElementById('categorySelect');
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        select.appendChild(option);
                    });
                });

            // 날짜 선택기 초기화
            const dateSelect = document.getElementById('dateSelect');
            const today = new Date().toISOString().split('T')[0];
            dateSelect.value = today;
            dateSelect.max = today;

            // 데이터 로드
            function loadData() {
                const category = document.getElementById('categorySelect').value;
                const date = document.getElementById('dateSelect').value;
                
                if (category && date) {
                    fetch(`/api/rankings?category=${encodeURIComponent(category)}&date=${date}`)
                        .then(response => response.json())
                        .then(updateTable)
                        .catch(error => console.error('데이터 로드 실패:', error));
                }
            }

            // 이벤트 리스너 등록
            document.getElementById('categorySelect').addEventListener('change', loadData);
            document.getElementById('dateSelect').addEventListener('change', loadData);
        });
    </script>
</body>
</html> 